<!DOCTYPE html>
<html>

<head>
    <title>My Spotify App</title>
</head>


<body>
    <button id="login-button">ìŠ¤í¬í‹°íŒŒì´ë¡œ ë¡œê·¸ì¸</button>
    <div id="profile"></div>

    <script>
        // ğŸš¨ ë³¸ì¸ì˜ í´ë¼ì´ì–¸íŠ¸ IDë¡œ ìˆ˜ì •í•˜ì„¸ìš”
        const clientId = '332d0e6079104c44a588fcb7eb116b44';
        // ğŸš¨ ë³¸ì¸ì˜ GitHub Pages ì½œë°± ì£¼ì†Œë¡œ ìˆ˜ì •í•˜ì„¸ìš”
        const redirectUri = 'https://chuforeva.github.io/JisooChart/callback';

        // === í˜ì´ì§€ ë¡œë“œ ì‹œ: ì´ë¯¸ ë¡œê·¸ì¸í–ˆëŠ”ì§€ í™•ì¸ ===
        window.onload = () => {
            const accessToken = localStorage.getItem('spotify_access_token');
            if (accessToken) {
                // í† í°ì´ ìˆìœ¼ë©´, ë¡œê·¸ì¸ ë²„íŠ¼ ìˆ¨ê¸°ê³  í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                document.getElementById('login-button').style.display = 'none';
                getUserProfile(accessToken);
            }
        };

        // === API í˜¸ì¶œ ì˜ˆì‹œ ===
        async function getUserProfile(token) {
            const response = await fetch('https://engineering.atspotify.com/2015/03/understanding-spotify-web-api5', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            document.getElementById('profile').innerText = `í™˜ì˜í•©ë‹ˆë‹¤, ${data.display_name}ë‹˜!`;
        }

        // === 1. ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ===
        document.getElementById('login-button').onclick = async () => {
            // 1. Verifier ìƒì„±
            const codeVerifier = generateRandomString(128);
            // 2. Challenge ìƒì„±
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            // 3. State ìƒì„±
            const state = generateRandomString(16);

            // 4. Verifierì™€ Stateë¥¼ ë¸Œë¼ìš°ì €ì— ì €ì¥ (callback.htmlì—ì„œ ì‚¬ìš©)
            localStorage.setItem('spotify_code_verifier', codeVerifier);
            localStorage.setItem('spotify_auth_state', state);

            // 5. ìŠ¤í¬í‹°íŒŒì´ ì¸ì¦ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
            const args = new URLSearchParams({
                response_type: 'code',
                client_id: clientId,
                scope: 'user-read-private user-read-email', // ìš”ì²­í•  ê¶Œí•œ
                redirect_uri: redirectUri,
                state: state,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge
            });
            window.location = 'https://accounts.spotify.com/authorize?' + args.toString();
        };

        // === PKCE í—¬í¼ í•¨ìˆ˜ë“¤ ===

        // (A) ëœë¤ ë¬¸ìì—´ ìƒì„±
        function generateRandomString(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        // (B) Code Challenge ìƒì„± (SHA256 -> Base64URL)
        async function generateCodeChallenge(codeVerifier) {
            const data = new TextEncoder().encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }
    </script>
</body>

</html>