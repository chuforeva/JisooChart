<!DOCTYPE html>
<html>

<head>
    <title>My Spotify App</title>
</head>


<body>
    <button id="login-button">스포티파이로 로그인</button>
    <div id="profile"></div>

    <script>
        // 🚨 본인의 클라이언트 ID로 수정하세요
        const clientId = '332d0e6079104c44a588fcb7eb116b44';
        // 🚨 본인의 GitHub Pages 콜백 주소로 수정하세요
        const redirectUri = 'https://chuforeva.github.io/JisooChart/callback';

        // === 페이지 로드 시: 이미 로그인했는지 확인 ===
        window.onload = () => {
            const accessToken = localStorage.getItem('spotify_access_token');
            if (accessToken) {
                // 토큰이 있으면, 로그인 버튼 숨기고 프로필 정보 가져오기
                document.getElementById('login-button').style.display = 'none';
                getUserProfile(accessToken);
            }
        };

        // === API 호출 예시 ===
        async function getUserProfile(token) {
            const response = await fetch('https://engineering.atspotify.com/2015/03/understanding-spotify-web-api5', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            document.getElementById('profile').innerText = `환영합니다, ${data.display_name}님!`;
        }

        // === 1. 로그인 버튼 클릭 시 ===
        document.getElementById('login-button').onclick = async () => {
            // 1. Verifier 생성
            const codeVerifier = generateRandomString(128);
            // 2. Challenge 생성
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            // 3. State 생성
            const state = generateRandomString(16);

            // 4. Verifier와 State를 브라우저에 저장 (callback.html에서 사용)
            localStorage.setItem('spotify_code_verifier', codeVerifier);
            localStorage.setItem('spotify_auth_state', state);

            // 5. 스포티파이 인증 페이지로 리디렉션
            const args = new URLSearchParams({
                response_type: 'code',
                client_id: clientId,
                scope: 'user-read-private user-read-email', // 요청할 권한
                redirect_uri: redirectUri,
                state: state,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge
            });
            window.location = 'https://accounts.spotify.com/authorize?' + args.toString();
        };

        // === PKCE 헬퍼 함수들 ===

        // (A) 랜덤 문자열 생성
        function generateRandomString(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        // (B) Code Challenge 생성 (SHA256 -> Base64URL)
        async function generateCodeChallenge(codeVerifier) {
            const data = new TextEncoder().encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }
    </script>
</body>

</html>