<!DOCTYPE html>
<html>
<head>
  <title>Spotify Auth Callback</title>
</head>
<body>
  ì¸ì¦ ì¤‘...

  <script>
    // ğŸš¨ ë³¸ì¸ì˜ í´ë¼ì´ì–¸íŠ¸ IDë¡œ ìˆ˜ì •í•˜ì„¸ìš”
    const clientId = '332d0e6079104c44a588fcb7eb116b44'; 
    // ğŸš¨ ë³¸ì¸ì˜ GitHub Pages ì½œë°± ì£¼ì†Œë¡œ ìˆ˜ì •í•˜ì„¸ìš”
    const redirectUri = 'https://chuforeva.github.io/JisooChart/callback.html';
    // ğŸš¨ ë³¸ì¸ì˜ ë©”ì¸ ì•± ì£¼ì†Œë¡œ ìˆ˜ì •í•˜ì„¸ìš”
    const mainAppUrl = 'https://chuforeva.github.io/JisooChart/'; 

    (async () => {
      // 1. URLì—ì„œ codeì™€ state íŒŒì‹±
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');

      // 2. localStorageì—ì„œ verifierì™€ state ë¶ˆëŸ¬ì˜¤ê¸°
      const storedState = localStorage.getItem('spotify_auth_state');
      const codeVerifier = localStorage.getItem('spotify_code_verifier');

      // 3. state ê°’ ë¹„êµ (ë³´ì•ˆ ê²€ì‚¬)
      if (state === null || state !== storedState) {
        alert('State ë¶ˆì¼ì¹˜ ì˜¤ë¥˜. ì¸ì¦ì„ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.');
        window.location.href = mainAppUrl;
        return;
      }

      // 4. ìŠ¤í¬í‹°íŒŒì´ í† í° ì—”ë“œí¬ì¸íŠ¸ì— POST ìš”ì²­
      try {
        const response = await fetch('https://accounts.spotify.com/api/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: new URLSearchParams({
            grant_type: 'authorization_code',
            code: code,
            redirect_uri: redirectUri,
            client_id: clientId,
            code_verifier: codeVerifier // ğŸ”‘ PKCEì˜ í•µì‹¬!
          })
        });

        if (!response.ok) {
          throw new Error('HTTP status ' + response.status);
        }

        const data = await response.json();

        // 5. í† í° ì €ì¥
        localStorage.setItem('spotify_access_token', data.access_token);
        localStorage.setItem('spotify_refresh_token', data.refresh_token);

        // 6. ì„ì‹œ ê°’ ì œê±°
        localStorage.removeItem('spotify_auth_state');
        localStorage.removeItem('spotify_code_verifier');

        // 7. ë©”ì¸ ì•±ìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜
        window.location.href = mainAppUrl;

      } catch (error) {
        console.error('Error fetching token:', error);
        alert('í† í° ë°œê¸‰ ì˜¤ë¥˜');
        window.location.href = mainAppUrl;
      }
    })();
  </script>
</body>
</html>