<!DOCTYPE html>
<html>
<head>
  <title>Spotify Auth Callback</title>
</head>
<body>
  인증 중...

  <script>
    // 🚨 본인의 클라이언트 ID로 수정하세요
    const clientId = '332d0e6079104c44a588fcb7eb116b44'; 
    // 🚨 본인의 GitHub Pages 콜백 주소로 수정하세요
    const redirectUri = 'https://chuforeva.github.io/JisooChart/callback.html';
    // 🚨 본인의 메인 앱 주소로 수정하세요
    const mainAppUrl = 'https://chuforeva.github.io/JisooChart/'; 

    (async () => {
      // 1. URL에서 code와 state 파싱
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');

      // 2. localStorage에서 verifier와 state 불러오기
      const storedState = localStorage.getItem('spotify_auth_state');
      const codeVerifier = localStorage.getItem('spotify_code_verifier');

      // 3. state 값 비교 (보안 검사)
      if (state === null || state !== storedState) {
        alert('State 불일치 오류. 인증을 다시 시도합니다.');
        window.location.href = mainAppUrl;
        return;
      }

      // 4. 스포티파이 토큰 엔드포인트에 POST 요청
      try {
        const response = await fetch('https://accounts.spotify.com/api/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: new URLSearchParams({
            grant_type: 'authorization_code',
            code: code,
            redirect_uri: redirectUri,
            client_id: clientId,
            code_verifier: codeVerifier // 🔑 PKCE의 핵심!
          })
        });

        if (!response.ok) {
          throw new Error('HTTP status ' + response.status);
        }

        const data = await response.json();

        // 5. 토큰 저장
        localStorage.setItem('spotify_access_token', data.access_token);
        localStorage.setItem('spotify_refresh_token', data.refresh_token);

        // 6. 임시 값 제거
        localStorage.removeItem('spotify_auth_state');
        localStorage.removeItem('spotify_code_verifier');

        // 7. 메인 앱으로 리디렉션
        window.location.href = mainAppUrl;

      } catch (error) {
        console.error('Error fetching token:', error);
        alert('토큰 발급 오류');
        window.location.href = mainAppUrl;
      }
    })();
  </script>
</body>
</html>